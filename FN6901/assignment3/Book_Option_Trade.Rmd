---
title: "Book Option Trade"
author: "William HU ZIHAO"
date: "2024-10-05"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(conflicted)
library(tidyverse)
library(lubridate)
library(bizdays)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", collapse = TRUE, cache = TRUE)
```

## Step 1 Load Option Data

**Replace *`data_path`* with the actual file path where the CSV is stored.**

```{r}
# Load the CSV file into a dataframe
data_path <- "./book_option_trade.csv"
book_option_trade <- read_csv(data_path)
```

```{r}
View(book_option_trade)
```

```{r}
# Check the structure of the dataframe
str(book_option_trade)

# Preview the first few rows of the dataframe
head(book_option_trade)

```

## Step 2 Data Cleaning

### 2.1 Data Type Conversion

```{r}
library(lubridate)

book_option_trade_formatted <- book_option_trade %>%filter(rowSums(is.na(.)) != ncol(.))%>%
  mutate(`Exp Date` = dmy(paste0("15-", substr(`Exp Date`, 1, 3), "-2024"))) # Extract first 3 chars for month

book_option_trade_formatted <- book_option_trade_formatted %>%
  mutate(across(c(Change, Volume, Change_put, Volume_put, `Open Int_put`),
                ~replace(., . == "--", "0")))

# Generated by ChatGPT to remove all chars could not be interpretted by Unicode
book_option_trade_formatted <- book_option_trade_formatted %>%
  mutate(across(c(Change, Change_put),
                ~as.numeric(str_replace_all(., "[^0-9.-]", ""))))


book_option_trade_formatted <- book_option_trade_formatted %>%
  mutate(across(c(Last, Bid, Ask, `Open Int`, Strike, Last_put, Bid_put, Ask_put),
                as.numeric)) %>%
  mutate(across(c(Volume, Volume_put, `Open Int_put`), as.numeric))


str(book_option_trade_formatted)
```

### 2.2 Columns Transformation

**Data frame columns:**

`| Exp. Date | Strike | OpenInterest | OptionType | Bid | Ask | Underlying | Today`

• Underlying/Today can be found on the top of the web page.

• OptionType is call for "Calls", put for "Puts"

• OpenInterest means the total number of outstanding contracts that are held by the two sides of market participants.

```{r}
# Create the call options data frame
call_options <- book_option_trade_formatted %>%
  select(
    `Exp Date`, 
    Strike, 
    OpenInterest = `Open Int`, 
    Bid, 
    Ask
  ) %>%
  mutate(OptionType = "call")

# Create the put options data frame
put_options <- book_option_trade_formatted %>%
  select(
    `Exp Date`, 
    Strike, 
    OpenInterest = `Open Int_put`, 
    Bid = Bid_put, 
    Ask = Ask_put
  ) %>%
  mutate(OptionType = "put")

call_options
put_options
```

```{r}
bot_final <- bind_rows(call_options, put_options)%>%mutate(Underlying = 572.86, Today = dmy("05-10-2024")) %>%
  mutate_if(is.numeric, as.double)

bot_final
```

## Step 2 Option Value Calculation

### 2.1 Call Options Alone

```{r}
call_value <- bot_final %>%
  filter(OptionType == "call") %>%          # Filter call options
  mutate(Value = OpenInterest * (Bid + Ask) / 2) %>%  # Calculate value
  summarise(TotalCallValue = sum(Value, na.rm = TRUE)) # Sum up the value
call_value
```

### 2.2 Put Options Alone

```{r}
put_value <- bot_final %>%
  filter(OptionType == "put") %>%          # Filter call options
  mutate(Value = OpenInterest * (Bid + Ask) / 2) %>%  # Calculate value
  summarise(TotalPutValue = sum(Value, na.rm = TRUE)) # Sum up the value
put_value
```

### 2.3 Call & Put Options

```{r}
option_value <- bot_final %>%
  mutate(Value = OpenInterest * (Bid + Ask) / 2) %>%  # Calculate value
  summarise(TotalOptionValue = sum(Value, na.rm = TRUE)) # Sum up the value
option_value
```

## Step 3 Open Interest of in Money and Out Money

```{r}
# Calculate total Open Interest for ITM and OTM for both Call and Put options in the same table
itm_otm_summary <- bot_final %>%
  summarise(
    TotalOpenInterest_ITM = sum(OpenInterest[(OptionType == "call" & Strike < Underlying) |
                                             (OptionType == "put" & Strike > Underlying)], na.rm = TRUE),
    TotalOpenInterest_OTM = sum(OpenInterest[(OptionType == "call" & Strike > Underlying) |
                                             (OptionType == "put" & Strike < Underlying)], na.rm = TRUE)
  )

# View result
itm_otm_summary
```

## Step 4 Plotting of Implied Volatility vs. Strike for OTM options

```{r}
library(NMOF)

# Define rate and today
rate <- 0.05
today <- as.Date("2024-10-05")  # Data retrieved on 05/10/2024
tau <- as.numeric((as.Date("2024-11-15") - today)) / 365

otm_options <- bot_final %>%
  filter((OptionType == "call" & Strike > Underlying) | 
         (OptionType == "put" & Strike < Underlying))

# Calculate implied volatility
otm_options <- otm_options %>%
  rowwise() %>%
  mutate(ImpliedVolatility = vanillaOptionImpliedVol(
    exercise = "european", 
    price = (Bid + Ask) / 2,  
    S = Underlying,
    X = Strike,
    tau = tau,
    r = rate,
    q = 0,
    type = OptionType
  )) %>%
  ungroup()

ggplot(otm_options, aes(x = Strike, y = ImpliedVolatility, color = OptionType)) +
  geom_point() +
  theme_minimal() +
  labs(title = "Implied Volatility vs. Strike Prices for OTM Options",
       x = "Strike Price",
       y = "Implied Volatility") +
  scale_color_manual(values = c("call" = "blue", "put" = "red")) +
  theme(legend.title = element_blank())

```

## Step 5 Plotting of Implied Volatility vs. Strike for OTM options from Yahoo Finance

### 5.1 Load Option Data from Yahoo

```{r}
library(readr)
book_option_trade_yahoo <- read_csv("./book_option_trade_yahoo.csv")
View(book_option_trade_yahoo)
```

```{r}
# Check the structure of the dataframe
str(book_option_trade_yahoo)

# Preview the first few rows of the dataframe
head(book_option_trade_yahoo)
```

### 5.2 Data Cleaning

#### 5.2.1 Data Type Conversion

```{r}
library(lubridate)
book_option_trade_yahoo_formatted <- book_option_trade_yahoo %>%filter(rowSums(is.na(.)) != ncol(.))%>%
  mutate(`Exp Date` = dmy(paste0("15-", substr(`Exp Date`, 1, 3), "-2024"))) # Extract first 3 chars for month

book_option_trade_yahoo_formatted <- book_option_trade_yahoo_formatted %>% 
  mutate(across(c(Last, Change, Bid, Ask, Volume, `Open Int`, Strike, 
                  Last_put, Change_put, Bid_put, Ask_put, Volume_put, `Open Int_put`), 
                ~replace(., . == "--", "0")))


# Generated by ChatGPT to remove all chars could not be interpretted by Unicode
book_option_trade_yahoo_formatted <- book_option_trade_yahoo_formatted %>%
  mutate(across(c(Change, Change_put),
                ~as.numeric(str_replace_all(., "[^0-9.-]", ""))))

book_option_trade_yahoo_formatted <- book_option_trade_yahoo_formatted %>%
  mutate(across(c(Last, Bid, Ask, `Open Int`, Strike, Last_put, Bid_put, Ask_put),
                as.numeric)) %>%
  mutate(across(c(Volume, Volume_put, `Open Int_put`), as.numeric))


str(book_option_trade_yahoo_formatted)
View(book_option_trade_yahoo_formatted)
```

#### 5.2.2 Column Transformation

```{r}
# Create the call options data frame
call_options_yahoo <- book_option_trade_yahoo_formatted %>%
  select(
    `Exp Date`, 
    Strike, 
    OpenInterest = `Open Int`, 
    Bid, 
    Ask
  ) %>%
  mutate(OptionType = "call")

# Create the put options data frame
put_options_yahoo <- book_option_trade_yahoo_formatted %>%
  select(
    `Exp Date`, 
    Strike, 
    OpenInterest = `Open Int_put`, 
    Bid = Bid_put, 
    Ask = Ask_put
  ) %>%
  mutate(OptionType = "put")

call_options_yahoo
put_options_yahoo
```

```{r}
bot_yahoo_final <- bind_rows(call_options_yahoo, put_options_yahoo) %>%
  mutate(Underlying = 572.98, Today = dmy("05-10-2024")) %>%
  mutate_if(is.numeric, as.double) %>%
  filter(!(Bid == 0 & Ask == 0))  # Remove rows where both Bid and Ask are 0

bot_yahoo_final
```

#### 5.2.3 Plot of Implied Volatility

```{r}
library(NMOF)

# Define rate and today
rate <- 0.05
today <- as.Date("2024-10-05")  # Data retrieved on 05/10/2024
tau <- as.numeric((as.Date("2024-11-15") - today)) / 365

otm_options_yahoo <- bot_yahoo_final %>%
  filter((OptionType == "call" & Strike > Underlying) | 
         (OptionType == "put" & Strike < Underlying))

# Calculate implied volatility
otm_options_yahoo <- otm_options_yahoo %>%
  rowwise() %>%
  mutate(ImpliedVolatility = vanillaOptionImpliedVol(
    exercise = "european", 
    price = (Bid + Ask) / 2,  
    S = Underlying,
    X = Strike,
    tau = tau,
    r = rate,
    q = 0,
    type = OptionType
  )) %>%
  ungroup()

ggplot(otm_options_yahoo, aes(x = Strike, y = ImpliedVolatility, color = OptionType)) +
  geom_point() +
  theme_minimal() +
  labs(title = "Implied Volatility vs. Strike Prices for OTM Options",
       x = "Strike Price",
       y = "Implied Volatility") +
  scale_color_manual(values = c("call" = "blue", "put" = "red")) +
  theme(legend.title = element_blank())
```
