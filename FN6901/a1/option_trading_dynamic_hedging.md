Option trading - dynamic hedging
================

# 0. Set Seed and Constants

``` r
set.seed(314123)
# Define parameters
num_sim<-1000
S <- 100        # Initial price
K <- 100        # Strike price
sigma_rel <- 0.3    # Realized volatility
sigma_imp <- 0.3    # Implied volatility
r_val <- 0      # Risk-free rate
q_val <- 0      # Dividend yield
timestep <- 1 / 250  # One day as a fraction of a year
days <- 20      # 20-day simulation

# Drift and volatility adjustments
p1 <- (r_val - q_val - 0.5 * sigma_rel^2) * timestep
p2 <- sigma_rel * sqrt(timestep)
```

# 1. Define Function to Run Option PnL Simulation

``` r
# Function to simulate option PnL
simulate_option_pnl <- function(number_of_simulations, S, K, sigma_rel, sigma_imp, r_val, q_val, timestep, days, p1, p2) {
  
  # Input validation GENERATED BY ChatGPT
  if (!is.numeric(number_of_simulations) || number_of_simulations <= 0) {
    stop("number_of_simulations must be a positive number")
  }
  if (!is.numeric(S) || S <= 0) {
    stop("S must be a positive number")
  }
  if (!is.numeric(K) || K <= 0) {
    stop("K must be a positive number")
  }
  if (!is.numeric(sigma_rel) || sigma_rel <= 0) {
    stop("sigma_rel must be a positive number")
  }
  if (!is.numeric(sigma_imp) || sigma_imp <= 0) {
    stop("sigma_imp must be a positive number")
  }
  if (!is.numeric(r_val)) {
    stop("r_val must be numeric")
  }
  if (!is.numeric(q_val)) {
    stop("q_val must be numeric")
  }
  if (!is.numeric(timestep) || timestep <= 0) {
    stop("timestep must be a positive number")
  }
  if (!is.numeric(days) || days <= 0) {
    stop("days must be a positive number")
  }
  if (!is.numeric(p1)) {
    stop("p1 must be numeric")
  }
  if (!is.numeric(p2) || p2 <= 0) {
    stop("p2 must be a positive number")
  }  
  # Core Simulation Logic
  sim_results <- map_dfr(1:number_of_simulations, function(dummy) {
    # Generate the price path (log-normal)
    ss <- c(S, rep(S, days) * cumprod(rlnorm(days, mean = p1, sd = p2)))
    
    # Create a dataframe for storing option prices and Greeks
    df <- tibble(S = ss, days = days:0, var = sigma_imp * sigma_imp, strike = K)
    
    # Calculate option price, delta, gamma, and theta for each day
    opt <- rowwise(df) %>%
      mutate(
        result = ifelse(
          days == 0,
          # Handle expiry (tau = 0) separately
          list(list(value = max(S - strike, 0), delta = 0, gamma = 0, theta = 0, vega = 0)),
          list(vanillaOptionEuropean(S = S, X = strike, tau = days / 250, r = r_val, q = q_val, v = var, type = "call", greeks = TRUE))
        ),
        price = result$value,
        delta = result$delta,
        gamma = result$gamma,
        theta = result$theta,
        vega = result$vega
      ) %>%
      ungroup()
    
    # Calculate the total PnL from Day 0 to Day 20
    option_PnL <- opt$price[days + 1] - opt$price[1]
    
    # Calculate sum of Gamma, Delta, and Theta contributions (sum of daily values)
    gamma_PnL <- sum(0.5 * opt$gamma[1:length(diff(opt$S))] * (diff(opt$S)^2))
    delta_PnL <- sum(opt$delta[1:length(diff(opt$S))] * diff(opt$S))
    theta_PnL <- sum(opt$theta * timestep)
    
    # Return the necessary values as a tibble
    return(tibble(
      option_PnL = option_PnL,
      gamma_PnL = gamma_PnL,
      delta_PnL = delta_PnL,
      theta_PnL = theta_PnL,
      vega_PnL = 0,# Since Vega is constant in your case
      vega0 = opt$vega[1]
      # option_premium = opt$price[1],
      # option_payoff = opt$price[days+1]
      ))
  })
  
  # Return simulation results
  return(sim_results)
}
```

# 2. Run Simulations

``` r
(sim_result <- simulate_option_pnl(
  number_of_simulations = num_sim, 
  S = S, 
  K = K, 
  sigma_rel = sigma_rel, 
  sigma_imp = sigma_imp, 
  r_val = r_val, 
  q_val = q_val, 
  timestep = timestep, 
  days = days, 
  p1 = p1, 
  p2 = p2
))
```

    ## # A tibble: 1,000 × 6
    ##    option_PnL gamma_PnL delta_PnL theta_PnL vega_PnL vega0
    ##         <dbl>     <dbl>     <dbl>     <dbl>    <dbl> <dbl>
    ##  1      5.96      2.24      5.12     -1.34         0  11.3
    ##  2      3.69      1.94      3.54     -1.94         0  11.3
    ##  3     -0.648     1.81     -0.253    -2.24         0  11.3
    ##  4     -3.38      1.77     -3.12     -2.07         0  11.3
    ##  5     -3.23      1.26     -1.80     -2.19         0  11.3
    ##  6     -3.38      0.795    -3.06     -1.16         0  11.3
    ##  7     -3.38      1.27     -3.35     -1.31         0  11.3
    ##  8      7.41      1.25      6.86     -0.666        0  11.3
    ##  9     -3.38      0.979    -2.54     -1.86         0  11.3
    ## 10     12.7       2.03     12.7      -1.75         0  11.3
    ## # ℹ 990 more rows

# 3. Analysis

## 3.1 Approximation of PnL by Taylor Expansion

1.  The sum of daily Taylors expansion is a close approximation to
    option PnL (which is the difference between option price on day 20
    and option price on day 0).

``` r
sim_result %>%
  summarize(
    Taylor_approx = mean(gamma_PnL + theta_PnL+delta_PnL+vega_PnL),
    Option_PnL = mean(option_PnL),
    Difference = mean(option_PnL) - mean(gamma_PnL + theta_PnL+delta_PnL+vega_PnL)
  )
```

    ## # A tibble: 1 × 3
    ##   Taylor_approx Option_PnL Difference
    ##           <dbl>      <dbl>      <dbl>
    ## 1        0.0654     0.0567   -0.00873

## 3.2 Gamma & Theta Neutralization

2.  When realized volatility and implied volatility are the same, Gamma
    and Theta can neutralize each other,
    i.e. $\sum_{i}^{N}(GammaPnL_i + ThetaPnL_i) \approx 0$

``` r
sim_result %>%
  summarize(
    Gamma_Theta_Sum = mean(gamma_PnL + theta_PnL)
  )
```

    ## # A tibble: 1 × 1
    ##   Gamma_Theta_Sum
    ##             <dbl>
    ## 1        -0.00883

## 3.3 Approximation of Sell Side PnL by Vega

3.  When implied volatility used to price the option is set to 0.5, but
    the realized volatility to generate simulated path is 0.3. The PnL
    from the sell side $PnL≈(Vol_{imp}−Vol_{Rel})Vega_0$. The PnL from
    sell side = the premium of the option + option payoff at expiry +
    delta hedging PnL. We assume zero transaction fee. Be aware that the
    sell side shall fulfill option payoff to the client.

``` r
(sim_result <- simulate_option_pnl(
  number_of_simulations = num_sim, 
  S = S, 
  K = K, 
  sigma_rel = sigma_rel, 
  sigma_imp = 0.5, 
  r_val = r_val, 
  q_val = q_val, 
  timestep = timestep, 
  days = days, 
  p1 = p1, 
  p2 = p2
))
```

    ## # A tibble: 1,000 × 6
    ##    option_PnL gamma_PnL delta_PnL theta_PnL vega_PnL vega0
    ##         <dbl>     <dbl>     <dbl>     <dbl>    <dbl> <dbl>
    ##  1     -2.60      1.09      0.368     -4.00        0  11.3
    ##  2     -3.23      1.15     -0.116     -4.07        0  11.3
    ##  3     -5.64      1.80     -3.58      -4.05        0  11.3
    ##  4     -5.64      1.97     -4.06      -3.74        0  11.3
    ##  5     -5.64      1.25     -3.56      -3.48        0  11.3
    ##  6     -5.64      1.09     -1.54      -4.49        0  11.3
    ##  7     -5.09      1.10     -1.05      -4.50        0  11.3
    ##  8     -5.64      0.761    -2.16      -4.28        0  11.3
    ##  9     -0.446     1.28      2.34      -4.19        0  11.3
    ## 10     -5.64      1.22     -1.65      -4.51        0  11.3
    ## # ℹ 990 more rows

``` r
sim_result %>%
  summarize(
    Sell_PnL = mean(delta_PnL-option_PnL),
    estimated_Sell_PnL = mean(vega0)*0.2
  )
```

    ## # A tibble: 1 × 2
    ##   Sell_PnL estimated_Sell_PnL
    ##      <dbl>              <dbl>
    ## 1     2.24               2.25

# 4. Conclusion

- The first result [3.1 Approximation of PnL by Taylor
  Expansion](#approximation-of-pnl-by-taylor-expansion) shows that the
  sum of daily Taylor expansion is a close approximation to the actual
  option PnL. The small difference between the Taylor-approximated PnL
  and the actual PnL (average difference ≈ -0.0087 over 1000
  simulations) demonstrates that the linearized PnL (using delta, gamma,
  theta, and vega terms) provides a reasonably accurate prediction of
  the overall PnL.

- When realized volatility and implied volatility are the same, the
  empirical results [3.2 Gamma & Theta
  Neutralization](#gamma-theta-neutralization) show that the average sum
  of Gamma PnL and Theta PnL across 1000 simulations is approximately
  -0.0088, which is very close to zero. This confirms that Gamma and
  Theta contributions tend to neutralize each other over time. The small
  deviation from zero is due to the non-linear nature of option pricing
  and the discretization of daily hedging.

- The average actual PnL from 1000 simulations [3.3 Approximation of
  Sell Side PnL by Vega](#approximation-of-sell-side-pnl-by-vega) is
  approximately 2.237, while the estimated PnL using the volatility
  difference is 2.251. The small difference between the two values
  highlights the accuracy of the approximation, validating that, as
  implied volatility is higher than realized volatility, the sell side
  earns a profit close to the expected value. The deviation can be
  attributed to the non-linearities of option pricing. Nonetheless, the
  results are consistent with theoretical expectations.
